<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aetherfall | The Grand Grimoire</title>
    
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/48/gold-bars.png">
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,700;1,400&family=Uncial+Antiqua&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --parchment: #fdfaf3;
            --ink: #1a1a1a;
            --gold: #b8924e;
            --gold-glow: rgba(184, 146, 78, 0.4);
            --riot-red: #9e0101;       
            --aether-blue: #0077be;    
            --glass: rgba(10, 10, 10, 0.9);
        }

        /* RESET & BASE */
        * { margin:0; padding:0; box-sizing:border-box; }
        html { scroll-behavior: smooth; }
        body { background: #050505; color: var(--ink); font-family: 'Inter', sans-serif; overflow-x: hidden; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 10px; }

        /* NAVIGATION */
        nav {
            position: fixed; top: 0; width: 100%; height: 70px;
            background: var(--glass); backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(184, 146, 78, 0.2);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 5%; z-index: 1000;
        }
        .nav-logo { color: var(--gold); font-family: 'Uncial Antiqua'; font-size: 1.4rem; letter-spacing: 2px; text-decoration: none; }

        /* ARCHITECT HUD (COMMAND CENTER) */
        #architectHUD {
            display: none; position: fixed; bottom: 30px; right: 30px;
            background: var(--glass); border: 1px solid var(--gold);
            padding: 25px; border-radius: 12px; z-index: 2000;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8); width: 380px;
            color: #fff; animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* MAIN GRIMOIRE CONTAINER */
        .grimoire {
            width: 95%; max-width: 1200px; margin: 100px auto 50px; 
            background: var(--parchment);
            background-image: url('https://www.transparenttextures.com/patterns/old-paper-2.png');
            box-shadow: 0 50px 100px rgba(0,0,0,0.9); border-radius: 4px; overflow: hidden;
        }
        
        header { text-align: center; padding: 120px 20px 80px; }
        header h1 { font-family: 'Uncial Antiqua'; font-size: clamp(3rem, 10vw, 5.5rem); color: #111; line-height: 1; }
        header p { color: var(--gold); letter-spacing: 12px; font-weight: 600; text-transform: uppercase; margin-top: 15px; font-size: 0.9rem; }

        /* INTERACTIVE TOPOGRAPHY */
        .map-section { padding: 60px 10%; background: rgba(0,0,0,0.03); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .map-layer {
            background: #fff; border: 1px solid rgba(0,0,0,0.1); padding: 25px; 
            cursor: pointer; border-radius: 4px; transition: 0.3s; margin-bottom: 12px;
        }
        .map-layer:hover { transform: translateX(10px); border-left: 4px solid var(--gold); }
        .layer-content { max-height: 0; overflow: hidden; transition: 0.4s ease; color: #555; font-family: 'Crimson Text'; font-size: 1.2rem; }
        .map-layer.active .layer-content { max-height: 200px; margin-top: 15px; }

        /* CHRONICLE */
        .chronicle-container { padding: 80px 15%; background: #fff; }
        .act-card { margin-bottom: 100px; border-bottom: 1px solid #eee; padding-bottom: 50px; animation: fadeIn 1s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .act-card h2 { font-family: 'Uncial Antiqua'; font-size: 2.8rem; margin-bottom: 20px; color: #111; }
        .act-card p { font-family: 'Crimson Text', serif; font-size: 1.4rem; color: #333; line-height: 1.7; text-align: justify; }

        /* FORM ELEMENTS */
        .input-field {
            width: 100%; padding: 14px; margin-bottom: 15px;
            background: rgba(255,255,255,0.05); border: 1px solid #444; 
            color: #fff; font-family: 'Inter'; border-radius: 4px;
        }
        .btn {
            padding: 12px 28px; border: none; cursor: pointer;
            font-family: 'Inter'; font-weight: 600; font-size: 0.8rem;
            text-transform: uppercase; letter-spacing: 2px; transition: 0.3s;
            border-radius: 2px; display: inline-block;
        }
        .btn-gold { background: var(--gold); color: #fff; }
        .btn-gold:hover { background: #96753d; box-shadow: 0 0 20px var(--gold-glow); }
        .btn-outline { background: transparent; border: 1px solid var(--gold); color: var(--gold); }
        .btn-danger { background: transparent; border: 1px solid var(--riot-red); color: var(--riot-red); margin-left: 10px; }

        /* AUTH MODAL */
        #authModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); z-index: 5000; align-items: center; justify-content: center;
        }
        .auth-box {
            background: var(--parchment); padding: 60px; width: 450px; border-radius: 4px;
            text-align: center; border: 1px solid var(--gold);
        }

        /* READER OVERLAY */
        .reader-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 4000; overflow-y: auto; padding: 60px 0;
        }
        .scroll-paper {
            width: 90%; max-width: 850px; margin: 0 auto; background: var(--parchment);
            padding: 100px 80px; position: relative; box-shadow: 0 0 100px rgba(0,0,0,0.5);
        }

        footer { padding: 80px 10%; background: #050505; color: var(--gold); text-align: center; }

        @media (max-width: 768px) {
            .chronicle-container { padding: 60px 8%; }
            .scroll-paper { padding: 60px 30px; }
            #architectHUD { width: 90%; right: 5%; left: 5%; }
        }
    </style>
</head>
<body>

<nav>
    <a href="#" class="nav-logo">AETHERFALL</a>
    <button class="btn btn-outline" id="authBtn">ARCHITECT LOGIN</button>
</nav>

<div id="architectHUD">
    <h3 style="font-family:'Uncial Antiqua'; color:var(--gold); margin-bottom:20px; letter-spacing:1px;">LATTICE COMMAND</h3>
    <input type="hidden" id="editId">
    <input type="text" id="actTitle" placeholder="Act Title" class="input-field">
    <textarea id="actPreview" placeholder="Brief Preview (Hook)" class="input-field" style="height:60px;"></textarea>
    <textarea id="actContent" placeholder="The Full Chronicle Text..." class="input-field" style="height:180px;"></textarea>
    <div style="display:flex; gap:10px;">
        <button class="btn btn-gold" id="saveBtn" style="flex:1;">COMMIT ACT</button>
        <button class="btn btn-outline" id="cancelBtn" style="display:none; color:#fff; border-color:#fff;">CANCEL</button>
    </div>
</div>

<div class="grimoire">
    <header>
        <p>The Grand Grimoire</p>
        <h1>Aetherfall</h1>
    </header>

    <section class="map-section">
        <span style="color:var(--gold); font-weight:600; letter-spacing:3px; display:block; margin-bottom:25px; font-size:0.8rem;">CITY TOPOGRAPHY</span>
        <div class="map-layer" onclick="this.classList.toggle('active')">
            <h3 style="font-family:'Uncial Antiqua'; font-size:1.6rem;">I. The High Rises</h3>
            <div class="layer-content">The peak of civilization. Gleaming ivory spires and golden wards. This is Sylva Morren's jurisdiction, where law is absolute and magic is clinical.</div>
        </div>
        <div class="map-layer" onclick="this.classList.toggle('active')">
            <h3 style="font-family:'Uncial Antiqua'; font-size:1.6rem;">II. The Midstack</h3>
            <div class="layer-content">The heart of Aetherfall. Cascading waterfalls and neon markets. Aelira Virex keeps the emotional resonance of the city flowing through its gravity-defying canals.</div>
        </div>
        <div class="map-layer" onclick="this.classList.toggle('active')">
            <h3 style="font-family:'Uncial Antiqua'; font-size:1.6rem;">III. The Underfall</h3>
            <div class="layer-content">The raw, vibrating foundations. A labyrinth of overclocked wires and leaking magic. Zyra Kade's homeâ€”where the rules of the Lattice are just suggestions.</div>
        </div>
    </section>

    <div class="chronicle-container">
        <div id="dynamic-acts">
            </div>
    </div>

    <section style="padding: 100px 10%; background: rgba(184, 146, 78, 0.05); text-align: center;">
        <h2 style="font-family:'Uncial Antiqua'; font-size: 2.5rem; margin-bottom: 15px;">Become a Witness</h2>
        <p style="color: #666; margin-bottom: 30px;">Tether your email to the Lattice to receive notifications of new Chronicles.</p>
        <div style="max-width: 500px; margin: 0 auto; display: flex; gap: 10px;">
            <input type="email" id="subEmail" placeholder="your-email@aether.com" style="flex:1; padding:15px; border:1px solid #ccc; font-family:'Inter'; outline:none;">
            <button class="btn btn-gold" id="subBtn">TETHER</button>
        </div>
        <p id="subMsg" style="margin-top:20px; font-weight:600; display:none;"></p>
    </section>
</div>

<footer>
    <p style="font-family: 'Uncial Antiqua'; font-size: 1.2rem; letter-spacing: 3px;">AETHERFALL ARCHIVES</p>
    <p style="font-size: 0.7rem; opacity: 0.5; margin-top: 20px; text-transform: uppercase;">Protected by the Grand Architect &copy; 2025</p>
</footer>

<div id="authModal">
    <div class="auth-box">
        <h2 style="font-family:'Uncial Antiqua'; font-size:2rem; margin-bottom:30px;">Rite of Initiation</h2>
        <input type="email" id="loginEmail" placeholder="Architect Email" class="input-field" style="color:#000; border-color:#ccc;">
        <input type="password" id="loginPass" placeholder="Secret Key" class="input-field" style="color:#000; border-color:#ccc;">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-gold" id="doLogin" style="flex:1;">SIGN IN</button>
            <button class="btn btn-outline" id="closeAuth">CLOSE</button>
        </div>
    </div>
</div>

<div id="readerOverlay" class="reader-overlay">
    <div class="scroll-paper">
        <button onclick="closeReader()" style="position:absolute; top:40px; right:40px; background:none; border:none; font-size:2.5rem; cursor:pointer;">&times;</button>
        <h2 id="readerTitle" style="font-family:'Uncial Antiqua'; font-size:4rem; color:var(--gold); margin-bottom:40px; line-height:1;"></h2>
        <div id="readerBody"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDvY6EBbx55sK3F5ovjWDGexG9N58WXS-4",
        authDomain: "aetherfall-d35a2.firebaseapp.com",
        projectId: "aetherfall-d35a2",
        storageBucket: "aetherfall-d35a2.firebasestorage.app",
        messagingSenderId: "107057087956",
        appId: "1:107057087956:web:cd958bc57a400502d1c241"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const ADMIN_UID = "RJUAtLpVpoacDbdYORcUiSIU20v2";

    // --- DATA STREAM ---
    onSnapshot(query(collection(db, "acts"), orderBy("createdAt", "desc")), (snap) => {
        const container = document.getElementById('dynamic-acts');
        container.innerHTML = "";
        snap.forEach(s => {
            const act = s.data();
            const id = s.id;
            window[`act_${id}`] = act;
            
            let controls = "";
            if(auth.currentUser && auth.currentUser.uid === ADMIN_UID) {
                controls = `
                    <div style="margin-top:20px; border-top:1px dashed #ddd; padding-top:20px;">
                        <button class="btn btn-outline" onclick="editAct('${id}')">REWRITE</button>
                        <button class="btn btn-danger" onclick="deleteAct('${id}')">ERASE</button>
                    </div>`;
            }

            container.innerHTML += `
                <div class="act-card">
                    <h2>${act.title}</h2>
                    <p>${act.preview}</p>
                    <button class="btn btn-gold" onclick="openReader('${id}')">READ FULL CHRONICLE</button>
                    ${controls}
                </div>`;
        });
    });

    // --- ARCHITECT COMMANDS ---
    document.getElementById('saveBtn').onclick = async () => {
        const title = document.getElementById('actTitle').value;
        const preview = document.getElementById('actPreview').value;
        const content = document.getElementById('actContent').value;
        const id = document.getElementById('editId').value;

        if(!title || !content) return alert("Manifestation incomplete.");

        try {
            if(id) {
                await updateDoc(doc(db, "acts", id), { title, preview, content });
            } else {
                await addDoc(collection(db, "acts"), { title, preview, content, createdAt: serverTimestamp() });
            }
            resetHUD();
        } catch(e) { alert("Lattice Error: " + e.message); }
    };

    window.editAct = (id) => {
        const act = window[`act_${id}`];
        document.getElementById('editId').value = id;
        document.getElementById('actTitle').value = act.title;
        document.getElementById('actPreview').value = act.preview;
        document.getElementById('actContent').value = act.content;
        document.getElementById('saveBtn').innerText = "UPDATE ACT";
        document.getElementById('cancelBtn').style.display = "block";
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    };

    window.deleteAct = async (id) => {
        if(confirm("Erase this timeline?")) await deleteDoc(doc(db, "acts", id));
    };

    const resetHUD = () => {
        document.getElementById('editId').value = "";
        document.getElementById('actTitle').value = "";
        document.getElementById('actPreview').value = "";
        document.getElementById('actContent').value = "";
        document.getElementById('saveBtn').innerText = "COMMIT ACT";
        document.getElementById('cancelBtn').style.display = "none";
    };
    document.getElementById('cancelBtn').onclick = resetHUD;

    // --- AUTHENTICATION ---
    document.getElementById('authBtn').onclick = () => {
        if(auth.currentUser) signOut(auth).then(() => location.reload());
        else document.getElementById('authModal').style.display = "flex";
    };
    
    document.getElementById('doLogin').onclick = () => {
        const e = document.getElementById('loginEmail').value;
        const p = document.getElementById('loginPass').value;
        signInWithEmailAndPassword(auth, e, p)
            .then(() => document.getElementById('authModal').style.display = "none")
            .catch(() => alert("Access Denied."));
    };

    onAuthStateChanged(auth, (user) => {
        const isAdmin = user && user.uid === ADMIN_UID;
        document.getElementById('architectHUD').style.display = isAdmin ? "block" : "none";
        document.getElementById('authBtn').innerText = user ? "SIGNOUT" : "ARCHITECT LOGIN";
    });

    // --- UTILITIES ---
    window.openReader = (id) => {
        const act = window[`act_${id}`];
        document.getElementById('readerTitle').innerText = act.title;
        document.getElementById('readerBody').innerText = act.content;
        document.getElementById('readerOverlay').style.display = "block";
        document.body.style.overflow = "hidden";
    };
    window.closeReader = () => {
        document.getElementById('readerOverlay').style.display = "none";
        document.body.style.overflow = "auto";
    };

    document.getElementById('subBtn').onclick = async () => {
        const email = document.getElementById('subEmail').value;
        if(!email.includes('@')) return;
        await addDoc(collection(db, "subscribers"), { email, date: serverTimestamp() });
        const m = document.getElementById('subMsg');
        m.innerText = "Tether Established."; m.style.display="block"; m.style.color="var(--gold)";
        document.getElementById('subEmail').value = "";
    };

    document.getElementById('closeAuth').onclick = () => document.getElementById('authModal').style.display = "none";
</script>
</body>
</html>
